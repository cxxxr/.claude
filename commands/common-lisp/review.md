---
description: Common Lispコードの包括的レビュー
argument-hint: "[path]"
---

指定されたパス（デフォルト: src/）のCommon Lispコードを包括的にレビューします。

## 対象パス
$ARGUMENTS

（引数がない場合は `src/` を対象とする）

## SubAgentの並列実行

以下の5つのSubAgentを**並列で**起動してください：

### 1. cl-linter
- `mallet -a $ARGUMENTS` で全ルールチェック
- 警告・エラーの一覧を収集
- 自動修正可能な問題を特定

### 2. cl-test-runner
- `rove *.asd` でテスト実行
- 失敗テストの原因を分析
- カバレッジ情報があれば収集

### 3. cl-codebase-analyst
- パッケージ依存関係を分析
- 未使用エクスポートを検出
- 複雑度の高い関数（循環複雑度 > 15）を特定
- デッドコード候補をリストアップ

### 4. cl-macro-verifier
- defmacro を含むファイルを検出
- 各マクロの衛生性を検証（gensym、once-only）
- 複数評価・変数捕捉の問題を検出

### 5. cl-dependency-resolver
- .asd ファイルの依存関係を確認
- 未使用の依存がないか確認
- バージョン競合の可能性を検出

## 結果の統合

各SubAgentの結果を以下の形式で統合：

```markdown
# Common Lisp コードレビュー

**対象**: [path]
**実行日時**: YYYY-MM-DD HH:MM:SS

## 品質スコア: X / 100

| カテゴリ | スコア | 重み |
|---------|--------|------|
| Lint | X/25 | 25% |
| Tests | X/25 | 25% |
| 構造 | X/20 | 20% |
| マクロ | X/15 | 15% |
| 依存関係 | X/15 | 15% |

---

## 1. Lint結果 (cl-linter)

### サマリー
| 重大度 | 件数 |
|--------|------|
| Error | X |
| Warning | X |
| Convention | X |
| Format | X |

### 重大な問題
[Error/Warningの詳細]

### 自動修正可能
```bash
mallet --fix [path]
```
で修正可能な項目: X件

---

## 2. テスト結果 (cl-test-runner)

### サマリー
- 総テスト数: X
- 成功: X (XX%)
- 失敗: X
- スキップ: X

### 失敗テスト詳細
[失敗テストの原因と修正案]

---

## 3. コード構造 (cl-codebase-analyst)

### パッケージ依存関係
[依存グラフまたはテーブル]

### 問題点
- 循環依存: [あり/なし]
- 未使用エクスポート: X件
- デッドコード候補: X件

### 複雑度警告
| 関数 | 複雑度 | 推奨 |
|------|--------|------|
| func-name | 25 | < 15 |

---

## 4. マクロ検証 (cl-macro-verifier)

### 検出されたマクロ: X個

### 問題のあるマクロ
| マクロ | 問題 | 重大度 |
|--------|------|--------|
| with-xxx | gensym未使用 | 高 |

### 安全なマクロ
[問題なしのマクロ一覧]

---

## 5. 依存関係 (cl-dependency-resolver)

### 外部依存: X個
[依存ライブラリ一覧]

### 問題点
- 未使用依存: [あり/なし]
- 古いバージョン: [あり/なし]

---

## 総合評価

### 良い点
[コードの優れた部分を具体的に]

### 改善が必要な点

#### 即座に対応（重大度: 高）
1. [具体的な問題と修正方法]

#### 推奨対応（重大度: 中）
1. [具体的な問題と修正方法]

#### 検討事項（重大度: 低）
1. [スタイル改善の提案]

---

## 推奨アクション

### 自動修正
```bash
# フォーマット修正
mallet --fix [path]
```

### 手動修正が必要
1. [ファイル:行番号] - [問題の説明]
2. ...

### 次のステップ
1. 上記の問題を修正
2. `/common-lisp:pr-check` で最終確認
3. PR作成
```

## スコア算出基準

### Lint (25点)
- Error: -10点/件
- Warning: -3点/件
- Convention: -1点/件
- Format: -0.5点/件

### Tests (25点)
- 全パス: 25点
- 失敗率に応じて減点: 25 × 成功率

### 構造 (20点)
- 循環依存あり: -10点
- 未使用エクスポート: -2点/件
- 複雑度超過関数: -3点/件

### マクロ (15点)
- マクロなし: 15点（満点）
- 問題なし: 15点
- 衛生性問題: -5点/件
- 複数評価問題: -5点/件

### 依存関係 (15点)
- 問題なし: 15点
- 未使用依存: -3点/件
- バージョン問題: -5点/件

## 注意事項

- 並列実行により高速化（5つのSubAgentが同時に動作）
- テストが存在しない場合、Tests は N/A としてスコア再計算
- マクロが存在しない場合、マクロ検証はスキップ
- 問題の修正は自動で行わない（レポートのみ）
- 修正を希望する場合は「問題を修正してください」と依頼
